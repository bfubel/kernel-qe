---
######################################################################
#   Job Name: VSPERF_CI Gateing IXGBE
#   Test: /kernel/networking/ovs-dpdk/ovs-dpdk-tunneling-beijing
#   DUT Back 2 back: netqe23.knqe.lab.eng.bos.redhat.com to netqe11.knqe.lab.eng.bos.redhat.com
#   Traffic Gen: None
#   Test Bed: Performance 6
# Netscout connection
#  NETQE23_enp131s0np0 <--> NETQE11 p7p1
#  NETQE23_enp131s0np1 <--> NETQE11 p7p2
#
#
######################################################################
- job-template:
    name: 'performace/dpdk-tunnel/ovs-dpdk-tunnel-i40e-mlx4-ci'
    defaults: defaults-build
    node: 'kernel-qe-ovs'
    properties:
        - ownership:
            owner: bfubel
            co-owners:
                - bfubel
                - bfubel
    parameters:
        - extended-choice:
              name: COMPOSE_CHECKBOX
              type: checkbox
              value: !join:
                - ','
                -
                  - RHEL-7.7
                  - RHEL-7.8
                  - RHEL-7.9
                  - RHEL-8.0
                  - RHEL-8.1.0
                  - RHEL-8.1.1
                  - RHEL-8.2
              visible-items: 7
              default-value: RHEL-7.7
        - extended-choice:
              name: OVS_CHECKBOX
              type: checkbox
              value: !join:
                - ','
                -
                    - OVS-2.90
                    - OVS-2.11
                    - OVS-2.12
                    - OVS-2.13
              visible-items: 4
              default-value: OVS-2.90,OVS-2.11
        - string:
            name: COMPOSE_77
            default: "RHEL-7.7-20190716.0"
            description: "RHEL-7.7 compose"
        - string:
            name: COMPOSE_78
            default: "RHEL-7.8-20200203.n.0"
            description: "RHEL-7.8 compose"
        - string:
            name: COMPOSE_79
            default: "RHEL-7.9-20200201.n.0"
            description: "RHEL-7.9 compose"
        - string:
            name: COMPOSE_80
            default: "RHEL-8.0.0-20190321.0"
            description: "RHEL-8.0 Compose"
        - string:
            name: COMPOSE_81
            default: "RHEL-8.1.0-20191015.0"
            description: "RHEL-8.1 Compose"
        - string:
            name: COMPOSE_811
            default: "RHEL-8.1.1-2020203.n.0"
            description: "RHEL-8.1.1 Compose"
        - string:
            name: COMPOSE_82
            default: "RHEL-8.2.0-2020227.0"
            description: "RHEL-8.2 Compose"
        - string:
            name: RPM_OVS290_7x
            default: "http://download-node-02.eng.bos.redhat.com/brewroot/packages/openvswitch/2.9.0/125.el7fdp/x86_64/openvswitch-2.9.0-125.el7fdp.x86_64.rpm"
            description: "RHEL-7.7 OVS 2.90 RPM"
        - string:
            name: RPM_OVS211_7x
            default: "http://download.eng.bos.redhat.com/brewroot/packages/openvswitch2.11/2.11.0/48.el7fdp/x86_64/openvswitch2.11-2.11.0-48.el7fdp.x86_64.rpm"
            description: "RHEL-7.7 OVS 2.11 RPM"
        - string:
            name: RPM_OVS212_7x
            default: "http://download.eng.bos.redhat.com/brewroot/packages/openvswitch2.12/2.12.0/22.el7fdp/x86_64/openvswitch2.12-2.12.0-22.el7fdp.x86_64.rpm"
            description: "RHEL-7.7 OVS 2.12 RPM"
        - string:
            name: RPM_OVS211_8x
            default: "http://download.eng.bos.redhat.com/brewroot/packages/openvswitch2.11/2.11.0/48.el8fdp/x86_64/openvswitch2.11-2.11.0-48.el8fdp.x86_64.rpm"
            description: "RHEL-8.0 OVS 2.11 RPM"
        - string:
            name: RPM_OVS212_8x
            default: "http://download.eng.bos.redhat.com/brewroot/packages/openvswitch2.12/2.12.0/22.el8fdp/x86_64/openvswitch2.12-2.12.0-22.el8fdp.x86_64.rpm"
            description: "RHEL-8.0 OVS 2.12 RPM"
        - string:
            name: RPM_OVS213_8x
            default: "http://download.eng.bos.redhat.com/brewroot/packages/openvswitch2.13/2.13.0/0.20200117git8ae6a5f.el8fdp/x86_64/openvswitch2.13-2.13.0-0.20200117git8ae6a5f.el8fdp.x86_64.rpm"
            description: "RHEL-8.x OVS 2.13 RPM"
        - string:
            name: RPM_DRIVERCTL
            default: "http://download-node-02.eng.bos.redhat.com/brewroot/packages/driverctl/0.108/1.el8/noarch/driverctl-0.108-1.el8.noarch.rpm"
            description:
        - string:
            name: RPM_DPDK_7x
            default: "http://download-node-02.eng.bos.redhat.com/brewroot/packages/dpdk/18.11.2/1.el7/x86_64/dpdk-18.11.2-1.el7.x86_64.rpm"
            description:
        - string:
            name: RPM_DPDK_TOOLS_7x
            default: "http://download-node-02.eng.bos.redhat.com/brewroot/packages/dpdk/18.11.2/1.el7/x86_64/dpdk-tools-18.11.2-1.el7.x86_64.rpm"
            description:
        - string:
            name: RPM_DPDK_8x
            default: "http://download-node-02.eng.bos.redhat.com/brewroot/packages/dpdk/18.11.2/4.el8/x86_64/dpdk-18.11.2-4.el8.x86_64.rpm"
            description:
        - string:
            name: RPM_DPDK_TOOLS_8x
            default: "http://download-node-02.eng.bos.redhat.com/brewroot/packages/dpdk/18.11.2/4.el8/x86_64/dpdk-tools-18.11.2-4.el8.x86_64.rpm"
            description:
        - string:
            name: RPM_DPDK_8x_213
            default: "http://download-node-02.eng.bos.redhat.com/brewroot/packages/dpdk/19.11/1.el8/x86_64/dpdk-19.11-1.el8.x86_64.rpm"
            description:
        - string:
            name: RPM_DPDK_TOOLS_8x_213
            default: "http://download-node-02.eng.bos.redhat.com/brewroot/packages/dpdk/19.11/1.el8/x86_64/dpdk-tools-19.11-1.el8.x86_64.rpm"
            description:
        - string:
            name: DPDK_VER_7x
            default: "18.11.2"
            description: "Version of Rhel 7.x DPDK used"
        - string:
            name: DPDK_VER_8x_213
            default: "19.11"
            description: "Version of Rhel 8.x DPDK used for OVS 2.13"
        - string:
            name: RPM_OVS_SELINUX_EXTRA_77
            default: "http://download-node-02.eng.bos.redhat.com/brewroot/packages/openvswitch-selinux-extra-policy/1.0/14.el7fdp/noarch/openvswitch-selinux-extra-policy-1.0-14.el7fdp.noarch.rpm"
            description: "RHEL-7.7 openvswitch-selinux-extra-policy rpm location"
        - string:
            name: RPM_OVS_SELINUX_EXTRA_80
            default: "http://download-node-02.eng.bos.redhat.com/brewroot/packages/openvswitch-selinux-extra-policy/1.0/19.el8fdp/noarch/openvswitch-selinux-extra-policy-1.0-19.el8fdp.noarch.rpm"
            description: "RHEL-8.0 openvswitch-selinux-extra-policy rpm location"
        - string:
            name: TEST_INFO
            default: "20.B"
            description: "Notes to be added to Beaker job whiteboard"
        - string:
            name: CHOST
            default: "netqe23.knqe.lab.eng.bos.redhat.com"
            description: client Host
        - string:
            name: CNIC_TYPE
            default: "nfp"
            description: Interface Type
        - string:
            name: CNIC_PORT0_7x
            default: "enp131s0np0"
            description: Client 7.x nic_port0
        - string:
            name: CNIC_PORT1_7x
            default: "enp131s0np1"
            description: Client 7.x nic_port1
        - string:
            name: CNIC_PORT0_8x
            default: "enp134s0f0"
            description: Client 8.X nic_port0
        - string:
            name: CNIC_PORT1_8x
            default: "enp134s0f1"
            description: Client 8.X nic_port1
        - string:
            name: CNETSCOUT_PORT0
            default: "NETQE23_ENP131S0NP0"
            description: Client nic_port0
        - string:
            name: CNETSCOUT_PORT1
            default: "NETQE23_ENP131S0NP1"
            description: Client nic_port0
        - string:
            name: SHOST
            default: "netqe11.knqe.lab.eng.bos.redhat.com"
            description: Server Host
        - string:
            name: SNIC_TYPE
            default: "mlx4_en"
            description: Interface Type
        - string:
            name: SNIC_PORT0_7x
            default: "p7p1"
            description: Server 7.x nic_port0
        - string:
            name: SNIC_PORT1_7x
            default: "p7p2"
            description: Server 7.x nic_port1
        - string:
            name: CNIC_PORT0_8x
            default: "enp4s0d0"
            description: Client 8.x nic_port0
        - string:
            name: CNIC_PORT1_8x
            default: "enp4s0d1"
            description: Client 8.x nic_port1
        - string:
            name: SNETSCOUT_PORT0
            default: "NETQE11_P7P1"
            description: Server nic_port0
        - string:
            name: SNETSCOUT_PORT1
            default: "NETQE11_P7P2"
            description: Server nic_port0
        - string:
            name: NETSCOUT
            default: "bos_100G.cfg"
            description: 'bos_100G.cfg,bos_10G.cfg,bej_100G.cfg,bej_10G.cfg'
        - string:
            name: ARCH
            default: x86_64
            description: ARCH
        - string:
            name: NOTES
            default: ""
            description: Run Notes
        - string:
            name: NOTIFY
            default: 'bfubel@redhat.com'
            description: Beaker Notify List
    wrappers:
        - build-name:
            name: ${{ENV,var="BUILD_TAG"}}
    builders:
        - shell: |
            #!/bin/bash
            #Test Function to submit Beaker Job
            #########################################################################################
            # Function Name: Ovs_Version()                                                          #
            # Purpose:                                                                              #
            #  Checks the current test_rhel and test_ovs and sets the test_compose and test_ovs_rpm #
            #  To the proper Compose/URL for the Beaker_test script to build and launch the job     #
            #########################################################################################
            #########################################################################################
            # OVS Version Support
            ######################################
            # RHEL  |  2.90 | 2.11 | 2.12 | 2.13 #
            # 7.7   |    Y  |  Y   |   Y  |  N   #
            # 7.8   |    Y  |  Y   |   Y  |  N   #
            # 7.9   |    Y  |  Y   |   Y  |  N   #
            # 8.0   |    N  |  Y   |   Y  |  Y   #
            # 8.1   |    N  |  Y   |   Y  |  Y   #
            # 8.1.1 |    N  |  Y   |   Y  |  Y   #
            # 8.2   |    N  |  Y   |   Y  |  Y   #
            ######################################
            Ovs_version() {{
               echo "Return the right OVS RPM File location"

               if [[ $test_rhel =~ "7.7" ]] && [[ $test_ovs =~ (2.90) ]]; then
                test_ovs_rpm=$RPM_OVS290_7x
                test_compose=$COMPOSE_77
                test_dpdk=$RPM_DPDK_7x
                test_dpdk_tools=$RPM_DPDK_TOOLS_7x
                test_dpdk_ver=$DPDK_VER_7x
               fi

               if [[ $test_rhel =~ "7.8" ]] && [[ $test_ovs =~ (2.90) ]]; then
                test_ovs_rpm=$RPM_OVS290_7x
                test_compose=$COMPOSE_78
                test_dpdk=$RPM_DPDK_7x
                test_dpdk_tools=$RPM_DPDK_TOOLS_7x
                test_dpdk_ver=$DPDK_VER_7x
               fi

               if [[ $test_rhel =~ "7.9" ]] && [[ $test_ovs =~ (2.90) ]]; then
                test_ovs_rpm=$RPM_OVS290_7x
                test_compose=$COMPOSE_79
                test_dpdk=$RPM_DPDK_7x
                test_dpdk_tools=$RPM_DPDK_TOOLS_7x
                test_dpdk_ver=$DPDK_VER_7x
               fi

               if [[ $test_rhel =~ "7.7" ]] && [[ $test_ovs =~ (2.11) ]]; then
                test_ovs_rpm=$RPM_OVS211_7x
                test_compose=$COMPOSE_77
                test_dpdk=$RPM_DPDK_7x
                test_dpdk_tools=RPM_DPDK_TOOLS_7x
                test_dpdk_ver=$DPDK_VER_7x
               fi

               if [[ $test_rhel =~ "7.8" ]] && [[ $test_ovs =~ (2.11) ]]; then
                test_ovs_rpm=$RPM_OVS211_7x
                test_compose=$COMPOSE_78
                test_dpdk=$RPM_DPDK_7x
                test_dpdk_tools=$RPM_DPDK_TOOLS_7x
                test_dpdk_ver=$DPDK_VER_7x
               fi

               if [[ $test_rhel =~ "7.9" ]] && [[ $test_ovs =~ (2.11) ]]; then
                test_ovs_rpm=$RPM_OVS211_7x
                test_dpdk=$RPM_DPDK_7x
                test_dpdk_tools=$RPM_DPDK_TOOLS_7x
                test_compose=$COMPOSE_79
                test_dpdk_ver=$DPDK_VER_7x
               fi

               if [[ $test_rhel =~ "8.0" ]] && [[ $test_ovs =~ (2.11) ]]; then
                test_ovs_rpm=$RPM_OVS211_8x
                test_compose=$COMPOSE_80
                test_dpdk=$RPM_DPDK_8x
                test_dpdk_tools=$RPM_DPDK_TOOLS_8x
                test_dpdk_ver=$DPDK_VER_7x
               fi

               if [[ $test_rhel =~ "8.1.0" ]] && [[ $test_ovs =~ (2.11) ]]; then
                test_ovs_rpm=$RPM_OVS211_8x
                test_compose=$COMPOSE_81
                test_dpdk=$RPM_DPDK_8x
                test_dpdk_tools=$RPM_DPDK_TOOLS_8x
                test_dpdk_ver=$DPDK_VER_7x
               fi

               if [[ $test_rhel =~ "8.1.1" ]] && [[ $test_ovs =~ (2.11) ]]; then
                test_ovs_rpm=$RPM_OVS211_8x
                test_compose=$COMPOSE_811
                test_dpdk=$RPM_DPDK_8x
                test_dpdk_tools=$RPM_DPDK_TOOLS_8x
                test_dpdk_ver=$DPDK_VER_7x
               fi

               if [[ $test_rhel =~ "8.2" ]] && [[ $test_ovs =~ (2.11) ]]; then
                test_ovs_rpm=$RPM_OVS211_8x
                test_compose=$COMPOSE_82
                test_dpdk=$RPM_DPDK_8x
                test_dpdk_tools=$RPM_DPDK_TOOLS_8x
                test_dpdk_ver=$DPDK_VER_7x
               fi

               if [[ $test_rhel =~ "7.7" ]] && [[ $test_ovs =~ (2.12) ]]; then
                test_ovs_rpm=$RPM_OVS212_7x
                test_compose=$COMPOSE_77
                test_dpdk=$RPM_DPDK_7x
                test_dpdk_tools=$RPM_DPDK_TOOLS_7x
                test_dpdk_ver=$DPDK_VER_7x
               fi

               if [[ $test_rhel =~ "7.8" ]] && [[ $test_ovs =~ (2.12) ]]; then
                test_ovs_rpm=$RPM_OVS212_7x
                test_compose=$COMPOSE_78
                test_dpdk=$RPM_DPDK_7x
                test_dpdk_tools=$RPM_DPDK_TOOLS_7x
                test_dpdk_ver=$DPDK_VER_7x
               fi

               if [[ $test_rhel =~ "7.9" ]] && [[ $test_ovs =~ (2.12) ]]; then
                test_ovs_rpm=$RPM_OVS212_7x
                test_compose=$COMPOSE_79
                test_dpdk=$RPM_DPDK_7x
                test_dpdk_tools=$RPM_DPDK_TOOLS_7x
                test_dpdk_ver=$DPDK_VER_7x
               fi

               if [[ $test_rhel =~ "8.0" ]] && [[ $test_ovs =~ (2.12) ]]; then
                test_ovs_rpm=$RPM_OVS212_8x
                test_compose=$COMPOSE_80
                test_dpdk=$RPM_DPDK_8x
                test_dpdk_tools=$RPM_DPDK_TOOLS_8x
                test_dpdk_ver=$DPDK_VER_7x
               fi

               if [[ $test_rhel =~ "8.1.0" ]] && [[ $test_ovs =~ (2.12) ]]; then
                test_ovs_rpm=$RPM_OVS212_8x
                test_compose=$COMPOSE_81
                test_dpdk=$RPM_DPDK_8x
                test_dpdk_tools=$RPM_DPDK_TOOLS_8x
                test_dpdk_ver=$DPDK_VER_7x
               fi

               if [[ $test_rhel =~ "8.1.1" ]] && [[ $test_ovs =~ (2.12) ]]; then
                test_ovs_rpm=$RPM_OVS212_8x
                test_compose=$COMPOSE_811
                test_dpdk=$RPM_DPDK_8x
                test_dpdk_tools=$RPM_DPDK_TOOLS_8x
                test_dpdk_ver=$DPDK_VER_7x
               fi

               if [[ $test_rhel =~ "8.2" ]] && [[ $test_ovs =~ (2.12) ]]; then
                test_ovs_rpm=$RPM_OVS212_8x
                test_compose=$COMPOSE_82
                test_dpdk=$RPM_DPDK_8x
                test_dpdk_tools=$RPM_DPDK_TOOLS_8x
                test_dpdk_ver=$DPDK_VER_7x
               fi

               if [[ $test_rhel =~ "8.0" ]] && [[ $test_ovs =~ (2.13) ]]; then
                test_ovs_rpm=$RPM_OVS213_8x
                test_compose=$COMPOSE_80
                test_dpdk=$RPM_DPDK_8x_213
                test_dpdk_tools=$RPM_DPDK_TOOLS_8x_213
                test_dpdk_ver=$DPDK_VER_8x_213
               fi

               if [[ $test_rhel =~ "8.1.0" ]] && [[ $test_ovs =~ (2.13) ]]; then
                test_ovs_rpm=$RPM_OVS213_8x
                test_compose=$COMPOSE_81
                test_dpdk=$RPM_DPDK_8x_213
                test_dpdk_tools=$RPM_DPDK_TOOLS_8x_213
                test_dpdk_ver=$DPDK_VER_8x_213
               fi

               if [[ $test_rhel =~ "8.1.1" ]] && [[ $test_ovs =~ (2.13) ]]; then
                test_ovs_rpm=$RPM_OVS213_8x
                test_compose=$COMPOSE_811
                test_dpdk=$RPM_DPDK_8x_213
                test_dpdk_tools=$RPM_DPDK_TOOLS_8x_213
                test_dpdk_ver=$DPDK_VER_8x_213
               fi

               if [[ $test_rhel =~ "8.2" ]] && [[ $test_ovs =~ (2.13) ]]; then
                test_ovs_rpm=$RPM_OVS213_8x
                test_compose=$COMPOSE_82
                test_dpdk=$RPM_DPDK_8x_213
                test_dpdk_tools=$RPM_DPDK_TOOLS_8x_213
                test_dpdk_ver=$DPDK_VER_8x_213
               fi


            }}

            #########################################################################################
            # Function Name: Beaker_7x()                                                            #
            # Purpose:                                                                              #
            #  Create and submit the Beaker XML Job using 7.x RPMs & xml                            #
            #  test_compose and test_ovs_rpm need to be set                                         #
            #########################################################################################
            Beaker_7x() {{
              Ovs_version
              echo '********************************************************************************'
              echo "Testing 7.x RHEL=$test_rhel OVS=$test_ovs"
            ##########################
            #Test: dpdk-tunnel i40e-mlx4 RHEL-7.x  OVS 2.90, OVS 2.11,OVS 2.12
            ##########################
            echo "##################################################################"
            echo "#Test 7.x: dpdk-tunnel i40e-mlx4 $test_compose                   #"
            echo "#     Compose: $test_ovs_rpm                                     #"
            echo "#     OVS: $test_ovs_rpm                                         #"
            echo "#     DPDK: $test_dpdk                                           #"
            echo "#     DPDK_Tools: $test_dpdk_tools                               #"
            echo "#     DPDK_VER: $test_dpdk_ver                                   #"
            echo "#        Machine netqe23/netqe11                                 #"
            echo "#                                                                #"
            echo "#        Results need traffic search beeker output for           #"
            echo "#        Search the key word 'pps'                               #"
            echo "#                                                                #"
            echo "##################################################################"
            rm -f $WORKSPACE/jobhtml.txt
            touch $WORKSPACE/job.xml
            cat <<EOT > $WORKSPACE/job.xml
            <job retention_tag="active+1" product="cpe:/o:redhat:enterprise_linux">
              <notify>
                <cc>$NOTIFY</cc>
              </notify>
              <whiteboard>[$TEST_INFO] [ovs-dpdk-tunneling] [i40e-mlx4] [$CHOST] [$SHOST] [$test_compose] [Performace] [$test_ovs_rpm] [gre] [ipv4] </whiteboard>
              <recipeSet priority="Urgent">
                <recipe whiteboard="" role="None" ks_meta="" kernel_options="" kernel_options_post="">
                  <autopick random="false"/>
                  <watchdog panic="None"/>
                  <packages/>
                  <ks_appends/>
                  <repos/>
                  <distroRequires>
                            <and>
                                <distro_name op="=" value="$test_compose"/>
                                <distro_variant op="=" value="Server"/>
                                <distro_method op="=" value="nfs"/>
                                <distro_arch op="=" value="x86_64"/>
                            </and>
                        </distroRequires>
                  <hostRequires>
                            <and>
                                <hostname op="=" value="$CHOST"/>
                                <system_type op="=" value="machine"/>
                            </and>
                            <or>
                            </or>
                            <not>
                            </not>
                        </hostRequires>
                  <partitions>
                        </partitions>
                  <task name="/distribution/install" role="SERVERS">
                    <params>
                      <param name="DISTRO_BUILD" value="$test_compose"/>
                    </params>
                  </task>
                  <task name="/kernel/networking/ovs-dpdk/ovs-dpdk-tunneling-beijing" role="SERVERS">
                    <params>
                      <param name="NAY" value="yes"/>
                      <param name="nic_port0" value="$CNIC_PORT0_7x"/>
                      <param name="nic_port1" value="$CNIC_PORT1_7x"/>
                      <param name="tunnel_flag" value="gre"/>
                      <param name="ip_flag" value="ipv4"/>
                      <param name="NUMA_NODE" value="1"/>
                      <param name="driver_name" value="$CNIC_TYPE"/>
                      <param name="nic1_mac" value="3c:fd:fe:a0:38:d0"/>
                      <param name="dpdk_rpm" value="$test_dpdk"/>
                      <param name="dpdk_tools_rpm" value="$test_dpdk_tools"/>
                      <param name="guest_openvswitch_rpm" value="$test_ovs_rpm"/>
                      <param name="openvswitch_rpm" value="$test_ovs_rpm"/>
                      <param name="selinux_policy_rpm" value="$RPM_OVS_SELINUX_EXTRA_77"/>
                    </params>
                  </task>
                </recipe>
                <recipe whiteboard="" role="None" ks_meta="" kernel_options="" kernel_options_post="">
                  <autopick random="false"/>
                  <watchdog panic="None"/>
                  <packages/>
                  <ks_appends/>
                  <repos/>
                  <distroRequires>
                            <and>
                                <distro_name op="=" value="$test_compose"/>
                                <distro_variant op="=" value="Server"/>
                                <distro_method op="=" value="nfs"/>
                                <distro_arch op="=" value="x86_64"/>
                                        </and>
                        </distroRequires>
                  <hostRequires>
                            <and>
                                <hostname op="=" value="$SHOST"/>
                                <system_type op="=" value="machine"/>
                            </and>
                            <or>
                            </or>
                            <not>
                            </not>
                        </hostRequires>
                  <partitions>
                        </partitions>
                  <task name="/distribution/install" role="CLIENTS">
                    <params>
                      <param name="DISTRO_BUILD" value="$test_compose"/>
                    </params>
                  </task>
                  <task name="/kernel/networking/ovs-dpdk/ovs-dpdk-tunneling-beijing" role="CLIENTS">
                    <params>
                      <param name="NAY" value="yes"/>
                      <param name="nic_port0" value="$SNIC_PORT0_7x"/>
                      <param name="nic_port1" value="$SNIC_PORT1_7x"/>
                      <param name="tunnel_flag" value="gre"/>
                      <param name="ip_flag" value="ipv4"/>
                      <param name="NUMA_NODE" value="1"/>
                      <param name="driver_name" value="$SNIC_TYPE"/>
                      <param name="nic1_mac" value="e4:1d:2d:1e:d2:e0"/>
                      <param name="dpdk_rpm" value="$test_dpdk"/>
                      <param name="dpdk_tools_rpm" value="$test_dpdk_tools"/>
                      <param name="guest_openvswitch_rpm" value="$test_ovs_rpm"/>
                      <param name="openvswitch_rpm" value="$test_ovs_rpm"/>
                      <param name="selinux_policy_rpm" value="$RPM_OVS_SELINUX_EXTRA_77"/>
                    </params>
                  </task>
                </recipe>
              </recipeSet>
            </job>
            EOT
            #cat $WORKSPACE/job.xml
            bkr job-submit $WORKSPACE/job.xml |tee $WORKSPACE/bkr_job.txt
            grep Submitted $WORKSPACE/bkr_job.txt >$WORKSPACE/bkr_jobnum.txt
            BKR_JOBID=`cut -d\' -f2 $WORKSPACE/bkr_jobnum.txt`
            echo BKR_JOBID=$BKR_JOBID >> $WORKSPACE/job1.properties
            echo BKR_JOBID=$BKR_JOBID >> $WORKSPACE/jobhtml.txt
            BKR_JOBIDhtml=`cut -d\: -f2 $WORKSPACE/jobhtml.txt`
            echo 'BKR_JOBIDhtml='$BKR_JOBIDhtml >> $WORKSPACE/job1.properties
            echo ARCH=$ARCH >> $WORKSPACE/job1.properties
            if [ -z ${{BKR_JOBID_LIST+x}} ];
              then
              BKR_JOBID_LIST+=$BKR_JOBID
            else
              BKR_JOBID_LIST+=","
              BKR_JOBID_LIST+=$BKR_JOBID
            fi
            echo "BKR_JOBID_LIST="$BKR_JOBID_LIST

            if [ -z ${{BKR_JOBIDhtml_LIST+x}} ];
              then
              BKR_JOBIDhtml_LIST+=$BKR_JOBIDhtml
            else
              BKR_JOBIDhtml_LIST+=","
              BKR_JOBIDhtml_LIST+=$BKR_JOBIDhtml
            fi
            echo "BKR_JOBIDhtml_LIST="$BKR_JOBIDhtml_LIST
            index="${{#array[@]}}"
            echo "BKR_Results Index=$index"

            }}

            #########################################################################################
            # Function Name: Beaker_8x()                                                            #
            # Purpose:                                                                              #
            #  Create and submit the Beaker XML Job using 8.x RPMs & xml                            #
            #  test_compose and test_ovs_rpm need to be set                                         #
            #########################################################################################
            Beaker_8x() {{
            Ovs_version
            echo '********************************************************************************'
            echo "Testing 8.x RHEL=$test_rhel OVS=$test_ovs"
            ##########################
            #Test: dpdk-tunnel i40e-mlx4 RHEL-8.x  OVS 2.11,OVS 2.12
            ##########################
            echo "##################################################################"
            echo "#Test: dpdk-tunnel i40e-mlx4 RHEL-8.x  OVS 2.11,OVS 2.12         #"
            echo "#        Machine netqe22                                         #"
            echo "#        XENA_M7P0,XENA_M7P0                                     #"
            echo "#        Results need traffic search beeker output for           #"
            echo "# Search the key word 'Test case google sheet link is as follow' #"
            echo "#     Compose: $test_ovs_rpm                                     #"
            echo "#     OVS: $test_ovs_rpm                                         #"
            echo "#     DPDK: $test_dpdk                                           #"
            echo "#     DPDK_Tools: $test_dpdk_tools                               #"
            echo "#     DPDK_VER: $test_dpdk_ver                                   #"
            echo "##################################################################"
            rm -f $WORKSPACE/jobhtml.txt
            touch $WORKSPACE/job.xml
            cat <<EOT > $WORKSPACE/job.xml
            <job retention_tag="active+1" product="cpe:/o:redhat:enterprise_linux">
              <notify>
                <cc>$NOTIFY</cc>
              </notify>
              <whiteboard>[$TEST_INFO] [$test_compose] [Performace] [$test_ovs_rpm] [ovs-dpdk-tunnel] [i40e-mlx4] [$CHOST]</whiteboard>
              <recipeSet priority="High">
                <recipe whiteboard="[$TEST_INFO] [$test_compose] [Performace] [$test_ovs_rpm] [ovs-dpdk-tunnel] [i40e-mlx4] [$CHOST]" role="None" ks_meta="harness='restraint-rhts beakerlib'" kernel_options="" kernel_options_post="">
                  <autopick random="false"/>
                  <watchdog panic="None"/>
                  <packages/>
                  <ks_appends>
                    <ks_append><![CDATA[
            %post
            cat << EOF >/etc/yum.repos.d/beaker-postrepo0.repo
            [beaker-postrepo0]
            name=beaker-postrepo0
            baseurl=http://download.eng.pek2.redhat.com/nightly/latest-BUILDROOT-8-RHEL-8/compose/Buildroot/x86_64/os
            enabled=1
            gpgcheck=0
            skip_if_unavailable=1
            EOF
            %end
            ]]></ks_append>
                  </ks_appends>
                  <repos/>
                  <distroRequires>
                    <and>
                      <distro_name op="=" value="$test_compose"/>
                      <distro_variant op="=" value="BaseOS"/>
                      <distro_arch op="=" value="x86_64"/>
                    </and>
                  </distroRequires>
                  <hostRequires>
                    <and>
                      <hostname value="$CHOST" op="="/>
                    </and>
                    <system_type value="Machine"/>
                  </hostRequires>
                  <partitions/>
                  <task name="/distribution/install" role="SERVERS">
                    <params>
                      <param name="DISTRO_BUILD" value="$test_compose"/>
                    </params>
                  </task>
                  <task name="/kernel/networking/ovs-dpdk/ovs-dpdk-tunneling-beijing" role="SERVERS">
                     <params>
                      <param name="NAY" value="yes"/>
                      <param name="nic_port0" value="$CNIC_PORT0_8x"/>
                      <param name="nic_port1" value="$CNIC_PORT1_8x"/>
                      <param name="tunnel_flag" value="gre"/>
                      <param name="ip_flag" value="ipv4"/>
                      <param name="NUMA_NODE" value="1"/>
                      <param name="driver_name" value="$CNIC_TYPE"/>
                      <param name="nic1_mac" value="3c:fd:fe:a0:38:d0"/>
                      <param name="dpdk_rpm" value="$test_dpdk"/>
                      <param name="dpdk_tools_rpm" value="$test_dpdk_tools"/>
                      <param name="guest_openvswitch_rpm" value="$test_ovs_rpm"/>
                      <param name="openvswitch_rpm" value="$test_ovs_rpm"/>
                      <param name="selinux_policy_rpm" value="$RPM_OVS_SELINUX_EXTRA_80"/>
                    </params>
                  </task>
                  <task name="/distribution/reservesys" role="STANDALONE">
                    <params>
                      <param name="RESERVETIME" value="86400"/>
                      <param name="KILLTIMEOVERRIDE" value="64800"/>
                    </params>
                  </task>
                </recipe>
                <recipe whiteboard="[$TEST_INFO] [$test_compose] [Performace] [$test_ovs_rpm] [ovs-dpdk-tunnel] [i40e-mlx4] [$CHOST]" role="None" ks_meta="harness='restraint-rhts beakerlib'" kernel_options="" kernel_options_post="">
                  <autopick random="false"/>
                  <watchdog panic="None"/>
                  <packages/>
                  <ks_appends>
                    <ks_append><![CDATA[
            %post
            cat << EOF >/etc/yum.repos.d/beaker-postrepo0.repo
            [beaker-postrepo0]
            name=beaker-postrepo0
            baseurl=http://download.eng.pek2.redhat.com/nightly/latest-BUILDROOT-8-RHEL-8/compose/Buildroot/x86_64/os
            enabled=1
            gpgcheck=0
            skip_if_unavailable=1
            EOF
            %end
            ]]></ks_append>
                  </ks_appends>
                  <repos/>
                  <distroRequires>
                    <and>
                      <distro_name op="=" value="$test_compose"/>
                      <distro_variant op="=" value="BaseOS"/>
                      <distro_arch op="=" value="x86_64"/>
                    </and>
                  </distroRequires>
                  <hostRequires>
                    <and>
                      <hostname value="$SHOST" op="="/>
                    </and>
                    <system_type value="Machine"/>
                  </hostRequires>
                  <partitions/>
                  <task name="/distribution/install" role="SERVERS">
                    <params>
                      <param name="DISTRO_BUILD" value="$test_compose"/>
                    </params>
                  </task>
                  <task name="/kernel/networking/ovs-dpdk/ovs-dpdk-tunneling-beijing" role="CLIENTS">
                    <params>
                      <param name="NAY" value="yes"/>
                      <param name="nic_port0" value="$SNIC_PORT0_8x"/>
                      <param name="nic_port1" value="$SNIC_PORT1_8x"/>
                      <param name="tunnel_flag" value="gre"/>
                      <param name="ip_flag" value="ipv4"/>
                      <param name="NUMA_NODE" value="1"/>
                      <param name="driver_name" value="$SNIC_TYPE"/>
                      <param name="nic1_mac" value="e4:1d:2d:1e:d2:e0"/>
                      <param name="dpdk_rpm" value="$test_dpdk"/>
                      <param name="dpdk_tools_rpm" value="$test_dpdk_tools"/>
                      <param name="guest_openvswitch_rpm" value="$test_ovs_rpm"/>
                      <param name="openvswitch_rpm" value="$test_ovs_rpm"/>
                      <param name="selinux_policy_rpm" value="$RPM_OVS_SELINUX_EXTRA_80"/>
                    </params>
                  </task>
                  <task name="/distribution/reservesys" role="STANDALONE">
                    <params>
                      <param name="RESERVETIME" value="86400"/>
                      <param name="KILLTIMEOVERRIDE" value="64800"/>
                    </params>
                  </task>
                </recipe>
              </recipeSet>
            </job>
            EOT
            #cat $WORKSPACE/job.xml
            bkr job-submit $WORKSPACE/job.xml |tee $WORKSPACE/bkr_job.txt
            grep Submitted $WORKSPACE/bkr_job.txt >$WORKSPACE/bkr_jobnum.txt
            BKR_JOBID=`cut -d\' -f2 $WORKSPACE/bkr_jobnum.txt`
            echo BKR_JOBID=$BKR_JOBID >> $WORKSPACE/job1.properties
            echo BKR_JOBID=$BKR_JOBID >> $WORKSPACE/jobhtml.txt
            BKR_JOBIDhtml=`cut -d\: -f2 $WORKSPACE/jobhtml.txt`
            echo 'BKR_JOBIDhtml='$BKR_JOBIDhtml >> $WORKSPACE/job1.properties
            echo ARCH=$ARCH >> $WORKSPACE/job1.properties
            if [ -z ${{BKR_JOBID_LIST+x}} ];
              then
              BKR_JOBID_LIST+=$BKR_JOBID
            else
              BKR_JOBID_LIST+=","
              BKR_JOBID_LIST+=$BKR_JOBID
            fi
            echo "BKR_JOBID_LIST="$BKR_JOBID_LIST
             if [ -z ${{BKR_JOBIDhtml_LIST+x}} ];
              then
              BKR_JOBIDhtml_LIST+=$BKR_JOBIDhtml
            else
              BKR_JOBIDhtml_LIST+=","
              BKR_JOBIDhtml_LIST+=$BKR_JOBIDhtml
            fi
            echo "BKR_JOBIDhtml_LIST="$BKR_JOBIDhtml_LIST
            index="${{#array[@]}}"
            echo "BKR_Results Index=$index"
            }}

            #########################################################################################
            # Function Name: connect_netscout()                                                     #
            # Purpose:                                                                              #
            #  Map the netscout ports together for the test case                                    #
            #                                                                                       #
            #########################################################################################
            connect_netscout() {{
              cd '/root/NSConnect/NetScout/'
              /bin/cp -rf $NETSCOUT settings.cfg

              scl enable rh-python34 'python /root/NSConnect/NetScout/NSConnect.py --connect $CNETSCOUT_PORT0 $SNETSCOUT_PORT0'
              scl enable rh-python34 'python /root/NSConnect/NetScout/NSConnect.py --connect $CNETSCOUT_PORT1 $SNETSCOUT_PORT1'
              return
            }}

            ###################################################################
            # Connect Nextscout Ports (Warning Will blow off anything in use) #
            ###################################################################

            #connect_netscout

            #############################################################
            # Main Function
            #Process Check Box's RHEL x OVS
            # Call Beaker Job Submit
            # For 7.x Compose call
            # For 8.x Compose Call xxx (Don't run OVS2.90 on 8.x)
            #############################################################
            declare -a BRK_RESULTS
            irhel=0
            iresults=0
            IFS=', ' read -r -a array_compose <<< "$COMPOSE_CHECKBOX"
            IFS=',' read -r -a BKR_RESULTS <<< "$BKR_RESULTS"
            for test_rhel in "${{array_compose[@]}}"
            do
              #echo "$test_rhel"
              IFS=', ' read -r -a array_ovs <<< "$OVS_CHECKBOX"
              for test_ovs in "${{array_ovs[@]}}"
              do
                echo "Before 7x $test_rhel $test_ovs"
                if [[ $test_rhel =~ "7." ]] && [[ $test_ovs =~ (2.9|2.11|2.12) ]]; then
                  Beaker_7x
                  BKR_RESULTS[$iresults]+="Compose $test_rhel OVS $test_ovs "
                  echo "BKR_RESULTS_Main7=${{BKR_RESULTS[$iresults]}}"
                  ((iresults++))
                elif [[ $test_rhel =~ "8." ]] && [[ $test_ovs =~ (2.11|2.12|2.13) ]]; then
                  echo "Calling Beaker_8x"
                  Beaker_8x
                  BKR_RESULTS[$iresults]+="Compose $test_rhel  OVS $test_ovs "
                  echo "BKR_RESULTS_Main8=${{BKR_RESULTS[$iresults]}}"
                  ((iresults++))
                elif [1]; then
                  echo "no Match"
                fi
              done
            done
            for result in "${{BKR_RESULTS[@]}}"
              do
                 echo "Main_Result=$result"
              done

            ################################################################################
            # Save Beaker JOBID_LIST to properties
            # Save BKR_JOBIDhtml_LIST to properties
            ################################################################################
            echo ARCH=$ARCH >> $WORKSPACE/job1.properties
            echo "BKR_JOBID_LIST="$BKR_JOBID_LIST >> $WORKSPACE/job1.properties
            echo "BKR_JOBID_LIST="$BKR_JOBID_LIST
            echo "BKR_JOBIDhtml_LIST="$BKR_JOBIDhtml_LIST
            echo "BKR_JOBIDhtml_LIST="$BKR_JOBIDhtml_LIST >> $WORKSPACE/job1.properties
            echo "BKR_RESULTS="${{BKR_RESULTS[@]}} >> $WORKSPACE/job1.properties

        - inject:
            properties-file: $WORKSPACE/job1.properties
        - shell: |
            #!/bin/bash
            #########################################################################################
            # Function Name: Beaker_wait()                                                          #
            # Purpose:                                                                              #
            #  Wait for every Beaker Job to complete                                                #
            #  test_compose and test_ovs_rpm need to be set                                         #
            #########################################################################################
            Beaker_wait() {{
             echo '********************************************************************************'
             echo '*  Beaker_wait                                                                 *'
             echo '********************************************************************************'
             echo "BKR_JOBID_LIST="$BKR_JOBID_LIST
             echo "BKR_JOBIDhtml_LIST="$BKR_JOBIDhtml_LIST
             IFS=',' read -r -a bkr_jobid_array <<< "$BKR_JOBID_LIST"
             for bkr_id in "${{bkr_jobid_array[@]}}"
             do
              echo "Waiting for Job "$bkr_id
              bkr job-watch $bkr_id
             done
            }}

            #########################################################################################
            # Function Name: Beaker_results()                                                       #
            # Purpose:                                                                              #
            #  Collect the Beaker Results from each completed job                                   #
            #  test_compose and test_ovs_rpm need to be set                                         #
            #########################################################################################
            Beaker_results() {{
             echo '********************************************************************************'
             echo '*  Beaker_results                                                              *'
             echo '********************************************************************************'
             #echo "BKR_JOBID_LIST="$BKR_JOBID_LIST
             #echo "BKR_JOBIDhtml_LIST="$BKR_JOBIDhtml_LIST
             i=0
             IFS=', ' read -r -a array_compose <<< "$COMPOSE_CHECKBOX"
             IFS=', ' read -r -a array_ovs <<< "$OVS_CHECKBOX"
             IFS=',' read -r -a bkr_jobid_array <<< "$BKR_JOBID_LIST"
             #IFS=',' read -r -a BKR_RESULTS <<< "$BKR_RESULTS"
             rm -f $WORKSPACE/BKR_RESULTS.log
             for bkr_id in "${{bkr_jobid_array[@]}}"
             do
               #echo $bkr_id
               BKR_TESTS_JOB_EXEC=0
               BKR_TESTS_JOB_FAILED=0
               #echo "Start For jobid"
               for jobid in $bkr_id; do
                 bkr job-results --format junit-xml $bkr_id > $WORKSPACE/$jobid.xml
                    #echo "Start for testsuite"
                     for testsuite in $(grep hostname $WORKSPACE/$jobid.xml); do
                         echo $testsuite | grep tests= && BKR_TESTS_JOB_EXEC=$((BKR_TESTS_JOB_EXEC+$(echo $testsuite | cut -d'"' -f2)))
                         echo $testsuite | grep failures= && BKR_TESTS_JOB_FAILED=$((BKR_TESTS_JOB_FAILED+$(echo $testsuite | cut -d'"' -f2)))
               done
              echo "index before set="$i
              BKR_TESTS_JOB=('[{{" executor": "beaker", "arch": "'"$ARCH"'", "executed": "'"$BKR_TESTS_JOB_EXEC"'", "failed": "'"$BKR_TESTS_JOB_FAILED"'"}}]')
              #echo $bkr_id=$BKR_TESTS_JOB
              #echo "index="$i
              BKR_RESULTS[$i]="$bkr_id "
              BKR_RESULTS[$i]+=" $BKR_TESTS_JOB "
              BKR_RESULTS[$i]+='\n'
              #echo "BKR_RESULTS_Loop $i =${{BKR_RESULTS[$i]}}"
              ((i++))
             done
             done
             echo "BKR_RESULTS_ALL=${{BKR_RESULTS[@]}}" >> $WORKSPACE/job1.properties
             #echo "BKR_RESULT=$BKR_RESULTS"
             for result in "${{BKR_RESULTS[@]}}"
              do
                 #echo "Result=$result"
                 echo "Result=$result" >> $WORKSPACE/BKR_RESULTS.log
              done
            }}

            #############################################################
            # Main Function
            Beaker_wait
            Beaker_results
            cat $WORKSPACE/BKR_RESULTS.log


        # inject when all the env varables are all defined ??
        - inject:
            properties-file: $WORKSPACE/job1.properties


    publishers:
        - email-ext:
            recipients: bfubel@redhat.com
            subject: performace/dpdk-tunnel/ovs-dpdk-tunnel-i40e-mlx4-ci $CHOST $SHOST, $BUILD_URL
            body: |
              RHEL=${{ENV,var="COMPOSE_CHECKBOX"}}
              OVS=${{ENV,var="OVS_CHECKBOX"}}

              Results
              ${{ENV,var="BKR_RESULTS_ALL"}}
              Notes:{{ENV,var="NOTES"}}

            notify-every-unstable-build: false
            send-to-individuals: true
            always: true

- project:
    name: kernel-qe
    jobs:
      - 'performace/dpdk-tunnel/ovs-dpdk-tunnel-i40e-mlx4-ci'
###########################################################
#                        History                          #
###########################################################
# Date            Modifier    Details
# 22-sep-2019     bfubel    Created off ovs-dodk-tunneling-ci
#
#
